name: Production Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  AZURE_WEBAPP_NAME: 'extratime-app'
  DOTNET_VERSION: '10.0.x'
  TEST_DATABASE_TYPE: SqlServer

jobs:
  # Job 1: Run full test suite with SQL Server
  full-test-suite:
    name: Full Test Suite (SQL Server)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: extratime
          POSTGRES_PASSWORD: extratime_dev
          POSTGRES_DB: extratime
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - run: dotnet restore
      - run: dotnet build --no-restore --configuration Release
      
      # Run ALL integration tests with SQL Server
      - name: Run Full Integration Tests
        run: |
          dotnet test tests/ExtraTime.IntegrationTests/ExtraTime.IntegrationTests.csproj \
            --no-build --configuration Release \
            -- --coverage --coverage-output-format cobertura --coverage-output coverage.integration.cobertura.xml
        env:
          TEST_DATABASE_TYPE: SqlServer
          FOOTBALL_DATA_API_KEY: ${{ secrets.FOOTBALL_DATA_API_KEY }}
          
      # Run ALL API tests with SQL Server
      - name: Run Full API Tests
        run: |
          dotnet test tests/ExtraTime.API.Tests/ExtraTime.API.Tests.csproj \
            --no-build --configuration Release \
            -- --coverage --coverage-output-format cobertura --coverage-output coverage.api.cobertura.xml
        env:
          TEST_DATABASE_TYPE: SqlServer
      
      # Run unit and domain tests
      - name: Run Unit Tests
        run: |
          dotnet test tests/ExtraTime.UnitTests/ExtraTime.UnitTests.csproj \
            --no-build --configuration Release \
            -- --coverage --coverage-output-format cobertura --coverage-output coverage.unit.cobertura.xml
          
      - name: Run Domain Tests
        run: |
          dotnet test tests/ExtraTime.Domain.Tests/ExtraTime.Domain.Tests.csproj \
            --no-build --configuration Release \
            -- --coverage --coverage-output-format cobertura --coverage-output coverage.domain.cobertura.xml
      
      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: full-coverage-reports
          path: "tests/**/coverage/*.cobertura.xml"

  # Job 2: Manual approval gate for production
  approve-production:
    name: Approve Production Deployment
    needs: full-test-suite
    if: github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Approval Check
        run: |
          echo "‚úÖ Full test suite passed on SQL Server"
          echo "üöÄ Ready for production deployment"
          echo "‚è≥ Awaiting manual approval..."

  # Job 3: Build and Deploy
  build-and-deploy:
    name: Build and Deploy to ${{ github.event.inputs.environment }}
    needs: 
      - full-test-suite
      - approve-production
    if: always() && needs.full-test-suite.result == 'success' && (needs.approve-production.result == 'success' || needs.approve-production.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Publish
        run: dotnet publish src/ExtraTime.API/ExtraTime.API.csproj -c Release -o ./publish

      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef

      - name: Run Database Migrations
        env:
          CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING }}
        run: |
          dotnet ef database update \
            --project src/ExtraTime.Infrastructure \
            --startup-project src/ExtraTime.API \
            --connection "$CONNECTION_STRING"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./publish
      
      - name: Deployment Notification
        run: |
          echo "üéâ Deployment to ${{ github.event.inputs.environment }} complete!"
